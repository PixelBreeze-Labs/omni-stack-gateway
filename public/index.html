<!DOCTYPE html>
<html>
<head>
    <title>OneSignal Web Notification Test</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "723e0d81-3494-4f77-8505-53c7a5c243b9",
            });
        });
    </script>
</head>
<body>
<h1>OneSignal Web Notification Test</h1>
<p>User ID: <span id="userId">Not subscribed yet</span></p>
<button id="subscribeButton">Subscribe to Notifications</button>

<script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
        OneSignal.init({
            appId: "723e0d81-3494-4f77-8505-53c7a5c243b9",
            allowLocalhostAsSecureOrigin: true,
        });

        // Check if already subscribed
        OneSignal.isPushNotificationsEnabled().then(function(isEnabled) {
            if (isEnabled) {
                console.log("Push notifications are enabled!");
                displayUserId();
            }
        });

        // Handle subscription button
        document.getElementById('subscribeButton').addEventListener('click', function() {
            OneSignal.registerForPushNotifications();
            OneSignal.setSubscription(true);
        });

        // Show OneSignal User ID when available
        OneSignal.on('subscriptionChange', function (isSubscribed) {
            if (isSubscribed) {
                displayUserId();
            }
        });
    });

    function displayUserId() {
        OneSignal.getUserId().then(function(userId) {
            document.getElementById('userId').textContent = userId;
            console.log("OneSignal User ID:", userId);

            // Optional: Send this to your backend
            // registerWithBackend(userId);
        });
    }

    function registerWithBackend(oneSignalId) {
        // You can add code here to call your backend API
        // to register this browser with a test user
        fetch('http://localhost:3000/core-notifications/register-device', {
            method: 'POST',
            headers: {
                'Authorization': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2N2U1NmU2YTM2OWYxZDlhMmZmYjM2NjkiLCJlbWFpbCI6ImFsYmZlakBnbWFpbC5jb20iLCJjbGllbnRJZCI6IjY3OTI2ZDFjODk3YTYyMzg3MWM5NzhmMiIsInJlZ2lzdHJhdGlvblNvdXJjZSI6InNuYXBmb29kIiwicm9sZSI6InNuYXBmb29kX3VzZXIiLCJpYXQiOjE3NDMwOTc1NTIsImV4cCI6MTc0MzEyNjM1Mn0.FEiRr2vEhTZui20ebbcKrEmsR5nhYUSdgzhZPl7rDH0',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                deviceToken: oneSignalId,
                platform: 'web',
                userId: '67e56e6a369f1d9a2ffb3669'
            })
        })
            .then(response => response.json())
            .then(data => console.log('Registered with backend:', data))
            .catch(error => console.error('Error registering with backend:', error));
    }
</script>
</body>
</html>